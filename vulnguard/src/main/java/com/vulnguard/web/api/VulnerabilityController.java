package com.vulnguard.web.api;

import com.vulnguard.dto.VulnerabilityDto;
import com.vulnguard.service.VulnerabilityScraperService;
import com.vulnguard.service.VulnerabilityService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.util.List;

@RestController
@RequestMapping("/api/v1/vulnerabilities")
public class VulnerabilityController {

    private final VulnerabilityService vulnerabilityService;
    private final VulnerabilityScraperService scraperService;

    public VulnerabilityController(VulnerabilityService vulnerabilityService,
                                   VulnerabilityScraperService scraperService) {
        this.vulnerabilityService = vulnerabilityService;
        this.scraperService = scraperService;
    }

    @GetMapping
    public List<VulnerabilityDto> getAll() {
        return vulnerabilityService.findAll();
    }

    @GetMapping("/{id}")
    public VulnerabilityDto getById(@PathVariable Long id) {
        return vulnerabilityService.findById(id);
    }

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public VulnerabilityDto create(@Validated @RequestBody VulnerabilityDto dto) {
        return vulnerabilityService.create(dto);
    }

    @PutMapping("/{id}")
    public VulnerabilityDto update(@PathVariable Long id, @Validated @RequestBody VulnerabilityDto dto) {
        return vulnerabilityService.update(id, dto);
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void delete(@PathVariable Long id) {
        vulnerabilityService.delete(id);
    }

    @PostMapping("/scrape")
    @ResponseStatus(HttpStatus.OK)
    public int triggerScrape() throws IOException {
        return scraperService.scrapeAndPersist();
    }
}

