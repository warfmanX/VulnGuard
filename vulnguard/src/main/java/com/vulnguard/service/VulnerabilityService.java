package com.vulnguard.service;

import com.vulnguard.domain.Vulnerability;
import com.vulnguard.dto.VulnerabilityDto;
import com.vulnguard.repository.VulnerabilityRepository;
import com.vulnguard.web.api.error.NotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional
public class VulnerabilityService {

    private final VulnerabilityRepository repository;

    public VulnerabilityService(VulnerabilityRepository repository) {
        this.repository = repository;
    }

    public List<VulnerabilityDto> findAll() {
        return repository.findAll()
                .stream()
                .map(this::toDto)
                .collect(Collectors.toList());
    }

    public VulnerabilityDto findById(Long id) {
        Vulnerability vulnerability = repository.findById(id)
                .orElseThrow(() -> new NotFoundException("Vulnerability not found: " + id));
        return toDto(vulnerability);
    }

    public VulnerabilityDto create(VulnerabilityDto dto) {
        Vulnerability entity = toEntity(dto);
        entity.setId(null);
        return toDto(repository.save(entity));
    }

    public VulnerabilityDto update(Long id, VulnerabilityDto dto) {
        Vulnerability existing = repository.findById(id)
                .orElseThrow(() -> new NotFoundException("Vulnerability not found: " + id));

        existing.setTitle(dto.getTitle());
        existing.setDescription(dto.getDescription());
        existing.setSeverityScore(dto.getSeverityScore());
        existing.setPublishedDate(dto.getPublishedDate());

        return toDto(repository.save(existing));
    }

    public void delete(Long id) {
        if (!repository.existsById(id)) {
            throw new NotFoundException("Vulnerability not found: " + id);
        }
        repository.deleteById(id);
    }

    private VulnerabilityDto toDto(Vulnerability entity) {
        VulnerabilityDto dto = new VulnerabilityDto();
        dto.setId(entity.getId());
        dto.setTitle(entity.getTitle());
        dto.setDescription(entity.getDescription());
        dto.setSeverityScore(entity.getSeverityScore());
        dto.setPublishedDate(entity.getPublishedDate());
        return dto;
    }

    private Vulnerability toEntity(VulnerabilityDto dto) {
        Vulnerability entity = new Vulnerability();
        entity.setId(dto.getId());
        entity.setTitle(dto.getTitle());
        entity.setDescription(dto.getDescription());
        entity.setSeverityScore(dto.getSeverityScore());
        entity.setPublishedDate(dto.getPublishedDate());
        return entity;
    }
}

